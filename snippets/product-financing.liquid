{% comment %}
  Snippet: product-financing v2.0
  M√≥dulo unificado de financiaci√≥n con dise√±o moderno y animaciones.
  
  Uso desde bloque "Liquid personalizado" en PDP:
  {% render 'product-financing',
    enabled: true,
    title: 'Financiaci√≥n disponible',
    subtitle: 'Paga en cuotas sin inter√©s',
    months: '3,6,12,24',
    methods: 'Addi|addi.svg|https://addi.com,Mercado Pago|mercadopago.svg|#,Sistecr√©dito|sistecredito.svg|#',
    notes: 'Paga hasta en 24 meses con Sistecr√©dito y Addi.||Plan retoma disponible para tu bicicleta usada.',
    show_badges: true
  %}

  Caracter√≠sticas:
  ‚úì Dise√±o moderno con gradientes y animaciones
  ‚úì Badges por m√©todo de pago
  ‚úì Actualizaci√≥n autom√°tica al cambiar variante
  ‚úì Sin scripts externos bloqueantes
  ‚úì Totalmente responsive
{% endcomment %}

{% liquid
  assign enabled_str = enabled | default: 'true' | downcase
%}

{% if enabled_str == 'false' or enabled_str == '0' %}
  <!-- Oculto por configuraci√≥n -->
{% else %}
  {{ 'product-financing.css' | asset_url | stylesheet_tag }}

  {% liquid
    assign months_str = months | default: '3,6,12,24'
    assign months_arr = months_str | split: ','

    assign methods_str = methods | default: ''
    assign methods_arr = methods_str | split: ','

    assign notes_str = notes | default: ''
    assign notes_arr = notes_str | split: '||'

    assign heading = title | default: 'Financiaci√≥n disponible'
    assign subheading = subtitle | default: 'Paga en cuotas sin inter√©s'
    assign show_badges_bool = show_badges | default: true

    assign dom_id = 'financing-' | append: product.id | default: 'financing-generic'

    assign selected_variant = product.selected_or_first_available_variant
    if selected_variant == nil and product.variants.size > 0
      assign selected_variant = product.variants.first
    endif

    assign fallback_price_cents = 0
    if selected_variant
      assign fallback_price_cents = selected_variant.price
    elsif product
      assign fallback_price_cents = product.price
    endif
  %}

  <div id="{{ dom_id }}" class="product-financing" data-money-format="{{ shop.money_format | escape }}" data-currency="{{ shop.currency }}" data-locale="{{ request.locale.iso_code }}" data-fallback-price="{{ fallback_price_cents }}">
    <div class="financing__box">
      <div class="financing__header">
        <div class="financing__header-text">
          <h3 class="financing__title">üí≥ {{ heading }}</h3>
          <p class="financing__subtitle">{{ subheading }}</p>
        </div>
      </div>
      <div class="financing__content">
        <div class="financing__installment">
          <div class="financing__amount-wrapper">
            <span class="financing__amount-label">Cuota mensual</span>
            <div class="financing__amount" data-financing-amount>‚Äî</div>
          </div>
          <div class="financing__per">
            <span class="financing__per-text">Pagar en</span>
            <select class="financing__months" data-financing-months aria-label="Selecciona meses">
              {% for m in months_arr %}
                {% assign m_trim = m | strip %}
                <option value="{{ m_trim }}" {% if forloop.last %}selected{% endif %}>{{ m_trim }} cuotas</option>
              {% endfor %}
            </select>
          </div>
        </div>

        {% if methods_str != '' %}
          <div class="financing__methods">
            <div class="financing__methods-header">
              <span class="financing__methods-title">M√©todos disponibles</span>
            </div>
            <ul class="financing__logos" role="list">
              {% for method in methods_arr %}
                {% assign item = method | strip %}
                {% assign parts = item | split: '|' %}
                {% assign method_name = parts[0] | strip %}
                {% assign method_logo = parts[1] | default: '' | strip %}
                {% assign method_url  = parts[2] | default: '' | strip %}
                <li class="financing__logo-item">
                  {% if method_url != '' and method_url != '#' %}<a href="{{ method_url }}" class="financing__logo-link" target="_blank" rel="noopener noreferrer">{% endif %}
                    <div class="financing__logo-card">
                      <div class="financing__logo">
                        {% if method_logo != '' %}
                          {% if method_logo contains 'http' or method_logo contains '//' %}
                            <img src="{{ method_logo }}" alt="{{ method_name }}" loading="lazy" />
                          {% else %}
                            <img src="{{ method_logo | asset_url }}" alt="{{ method_name }}" loading="lazy" onerror="this.onerror=null;this.src='{{ method_logo | file_url }}';"/>
                          {% endif %}
                        {% else %}
                          <span class="financing__logo-fallback">{{ method_name }}</span>
                        {% endif %}
                      </div>
                      {% if show_badges_bool %}
                        <span class="financing__badge">0% inter√©s</span>
                      {% endif %}
                    </div>
                  {% if method_url != '' and method_url != '#' %}</a>{% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if notes_str != '' %}
          <div class="financing__notes">
            <ul class="financing__notes-list">
              {% for note in notes_arr %}
                {% assign note_text = note | strip %}
                {% if note_text != '' %}
                  <li class="financing__note-item">
                    <svg class="financing__check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>{{ note_text }}</span>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>

    <script type="application/json" data-financing-variants>
      [
      {% if product and product.variants.size > 0 %}
        {% for v in product.variants %}
          {"id": {{ v.id }}, "price": {{ v.price }} }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endif %}
      ]
    </script>

    <script>
    (function(){
      var root = document.getElementById('{{ dom_id }}');
      if(!root) return;
      var moneyFormat = root.getAttribute('data-money-format') || "${{amount}}";
      var currency = root.getAttribute('data-currency') || 'USD';
      var locale = root.getAttribute('data-locale') || 'es';
      var fallbackPrice = parseInt(root.getAttribute('data-fallback-price') || '0', 10) || 0;

      var amountEl = root.querySelector('[data-financing-amount]');
      var monthsSelect = root.querySelector('[data-financing-months]');

      var variantsJSON = [];
      try {
        var jsonEl = root.querySelector('[data-financing-variants]');
        if (jsonEl) variantsJSON = JSON.parse(jsonEl.textContent || '[]');
      } catch(e) { variantsJSON = []; }

      var priceById = {};
      variantsJSON.forEach(function(v){ priceById[v.id] = v.price; });

      function formatMoney(cents){
        if (window.Shopify && typeof Shopify.formatMoney === 'function') {
          return Shopify.formatMoney(cents, moneyFormat);
        }
        try {
          return new Intl.NumberFormat(locale, { style: 'currency', currency: currency, maximumFractionDigits: 0 }).format(cents/100);
        } catch(e) {
          return (cents/100).toFixed(0);
        }
      }

      function getCurrentVariantId(){
        var input = document.querySelector('form[action="/cart/add"] [name="id"]');
        if (!input) input = document.querySelector('[name="id"][form]');
        if (!input) input = document.querySelector('select[name="id"], input[name="id"][type="hidden"], input[name="id"][type="radio"]:checked');
        var val = input ? parseInt(input.value, 10) : NaN;
        if (!isNaN(val)) return val;
        // fallback to any key in map
        var keys = Object.keys(priceById);
        if (keys.length) return parseInt(keys[0], 10);
        return null;
      }

      function currentPriceCents(){
        var vid = getCurrentVariantId();
        if (vid && priceById[vid] != null) return parseInt(priceById[vid], 10) || 0;
        return fallbackPrice;
      }

      function updateAmount(){
        var m = parseInt(monthsSelect && monthsSelect.value || '1', 10) || 1;
        var price = currentPriceCents();
        if (!price || price <= 0) { amountEl.textContent = '‚Äî'; return; }
        var perMonth = Math.round(price / m);
        // A√±adir animaci√≥n de cambio
        amountEl.style.opacity = '0.5';
        setTimeout(function(){
          amountEl.textContent = formatMoney(perMonth);
          amountEl.style.opacity = '1';
        }, 150);
      }

      // React to month selection changes
      if (monthsSelect) monthsSelect.addEventListener('change', updateAmount);

      // React to theme-specific variant change events
      document.addEventListener('variant:change', function(e){
        if (e && e.detail && e.detail.variant) {
          var v = e.detail.variant;
          if (v && v.id && typeof v.price === 'number') priceById[v.id] = v.price;
          updateAmount();
        }
      });
      document.addEventListener('product:variant-change', function(){ updateAmount(); });

      // React to native changes on variant selector inputs
      document.addEventListener('change', function(ev){
        var t = ev.target;
        if (!t) return;
        if (t.name === 'id' || t.closest('variant-radios') || t.closest('variant-selects')) {
          updateAmount();
        }
      });

      // Initial calculation
      updateAmount();
    })();
    </script>
  </div>
{% endif %}
