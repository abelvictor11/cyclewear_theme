{% comment %}
  Snippet: product-financing v2.0
  Módulo unificado de financiación con diseño moderno y animaciones.
  
  Uso desde bloque "Liquid personalizado" en PDP:
  {% render 'product-financing',
    enabled: true,
    title: 'Financiación disponible',
    subtitle: 'Paga en cuotas sin interés',
    months: '3,6,12,24',
    methods: 'Addi|addi.svg|https://addi.com,Mercado Pago|mercadopago.svg|#,Sistecrédito|sistecredito.svg|#',
    notes: 'Paga hasta en 24 meses con Sistecrédito y Addi.||Plan retoma disponible para tu bicicleta usada.',
    show_badges: true
  %}

  Características:
  ✓ Diseño moderno con gradientes y animaciones
  ✓ Badges por método de pago
  ✓ Actualización automática al cambiar variante
  ✓ Sin scripts externos bloqueantes
  ✓ Totalmente responsive
{% endcomment %}

{% liquid
  assign enabled_str = enabled | default: 'true' | downcase
%}

{% if enabled_str == 'false' or enabled_str == '0' %}
  <!-- Oculto por configuración -->
{% else %}
  {{ 'product-financing.css' | asset_url | stylesheet_tag }}

  {% liquid
    assign months_str = months | default: '3,6,12,24'
    assign months_arr = months_str | split: ','

    assign methods_str = methods | default: ''
    assign methods_arr = methods_str | split: ','

    assign notes_str = notes | default: ''
    assign notes_arr = notes_str | split: '||'

    assign heading = title | default: 'Financiación disponible'
    assign subheading = subtitle | default: 'Paga en cuotas sin interés'
    assign show_badges_bool = show_badges | default: true

    assign dom_id = 'financing-' | append: product.id | default: 'financing-generic'

    assign selected_variant = product.selected_or_first_available_variant
    if selected_variant == nil and product.variants.size > 0
      assign selected_variant = product.variants.first
    endif

    assign fallback_price_cents = 0
    if selected_variant
      assign fallback_price_cents = selected_variant.price
    elsif product
      assign fallback_price_cents = product.price
    endif
  %}

  <div id="{{ dom_id }}" class="product-financing" data-money-format="{{ shop.money_format | escape }}" data-currency="{{ shop.currency }}" data-locale="{{ request.locale.iso_code }}" data-fallback-price="{{ fallback_price_cents }}">
    <div class="financing__box">

      <div class="financing__content">
        <div class="financing__installment">
          <div class="financing__amount-wrapper">
            <span class="financing__amount-label">Cuota mensual</span>
            <div class="financing__amount" data-financing-amount>—</div>
          </div>
          <div class="financing__per">
            <span class="financing__per-text">Pagar en</span>
            <select class="financing__months" data-financing-months aria-label="Selecciona meses">
              {% for m in months_arr %}
                {% assign m_trim = m | strip %}
                <option value="{{ m_trim }}" {% if forloop.last %}selected{% endif %}>{{ m_trim }} cuotas</option>
              {% endfor %}
            </select>
          </div>
        </div>

        {% if methods_str != '' %}
          <div class="financing__methods">
            <div class="financing__methods-header">
              <span class="financing__methods-title">Métodos de crédito disponibles</span>
            </div>
            <ul class="financing__logos" role="list">
              {% for method in methods_arr %}
                {% assign item = method | strip %}
                {% assign parts = item | split: '|' %}
                {% assign method_name = parts[0] | strip %}
                {% assign method_logo = parts[1] | default: '' | strip %}
                {% assign method_url  = parts[2] | default: '' | strip %}
                {% assign modal_id = parts[3] | default: '' | strip %}
                <li class="financing__logo-item">
                  {% if modal_id != '' %}
                    <button type="button" class="financing__logo-link financing__logo-btn" data-modal="{{ modal_id }}" aria-label="Más información sobre {{ method_name }}">
                  {% elsif method_url != '' and method_url != '#' %}
                    <a href="{{ method_url }}" class="financing__logo-link" target="_blank" rel="noopener noreferrer">
                  {% else %}
                    <div class="financing__logo-link">
                  {% endif %}
                    <div class="financing__logo-card">
                      <div class="financing__logo">
                        {% if method_logo != '' %}
                          {% if method_logo contains 'http' or method_logo contains '//' %}
                            <img src="{{ method_logo }}" alt="{{ method_name }}" loading="lazy" />
                          {% else %}
                            <img src="{{ method_logo | asset_url }}" alt="{{ method_name }}" loading="lazy" onerror="this.onerror=null;this.src='{{ method_logo | file_url }}';"/>
                          {% endif %}
                        {% else %}
                          <span class="financing__logo-fallback">{{ method_name }}</span>
                        {% endif %}
                      </div>
                      {% if show_badges_bool %}
                        <span class="financing__badge">0% interés</span>
                      {% endif %}
                    </div>
                  {% if modal_id != '' %}
                    </button>
                  {% elsif method_url != '' and method_url != '#' %}
                    </a>
                  {% else %}
                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if notes_str != '' %}
          <div class="financing__notes">
            <ul class="financing__notes-list">
              {% for note in notes_arr %}
                {% assign note_text = note | strip %}
                {% if note_text != '' %}
                  <li class="financing__note-item">
                    <svg class="financing__check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>{{ note_text }}</span>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>

    <script type="application/json" data-financing-variants>
      [
      {% if product and product.variants.size > 0 %}
        {% for v in product.variants %}
          {"id": {{ v.id }}, "price": {{ v.price }} }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endif %}
      ]
    </script>

    <script>
    (function(){
      var root = document.getElementById('{{ dom_id }}');
      if(!root) return;
      var moneyFormat = root.getAttribute('data-money-format') || "${{amount}}";
      var currency = root.getAttribute('data-currency') || 'USD';
      var locale = root.getAttribute('data-locale') || 'es';
      var fallbackPrice = parseInt(root.getAttribute('data-fallback-price') || '0', 10) || 0;

      var amountEl = root.querySelector('[data-financing-amount]');
      var monthsSelect = root.querySelector('[data-financing-months]');

      var variantsJSON = [];
      try {
        var jsonEl = root.querySelector('[data-financing-variants]');
        if (jsonEl) variantsJSON = JSON.parse(jsonEl.textContent || '[]');
      } catch(e) { variantsJSON = []; }

      var priceById = {};
      variantsJSON.forEach(function(v){ priceById[v.id] = v.price; });

      function formatMoney(cents){
        if (window.Shopify && typeof Shopify.formatMoney === 'function') {
          return Shopify.formatMoney(cents, moneyFormat);
        }
        try {
          return new Intl.NumberFormat(locale, { style: 'currency', currency: currency, maximumFractionDigits: 0 }).format(cents/100);
        } catch(e) {
          return (cents/100).toFixed(0);
        }
      }

      function getCurrentVariantId(){
        var input = document.querySelector('form[action="/cart/add"] [name="id"]');
        if (!input) input = document.querySelector('[name="id"][form]');
        if (!input) input = document.querySelector('select[name="id"], input[name="id"][type="hidden"], input[name="id"][type="radio"]:checked');
        var val = input ? parseInt(input.value, 10) : NaN;
        if (!isNaN(val)) return val;
        // fallback to any key in map
        var keys = Object.keys(priceById);
        if (keys.length) return parseInt(keys[0], 10);
        return null;
      }

      function currentPriceCents(){
        var vid = getCurrentVariantId();
        if (vid && priceById[vid] != null) return parseInt(priceById[vid], 10) || 0;
        return fallbackPrice;
      }

      function updateAmount(){
        var m = parseInt(monthsSelect && monthsSelect.value || '1', 10) || 1;
        var price = currentPriceCents();
        if (!price || price <= 0) { amountEl.textContent = '—'; return; }
        var perMonth = Math.round(price / m);
        // Añadir animación de cambio
        amountEl.style.opacity = '0.5';
        setTimeout(function(){
          amountEl.textContent = formatMoney(perMonth);
          amountEl.style.opacity = '1';
        }, 150);
      }

      // React to month selection changes
      if (monthsSelect) monthsSelect.addEventListener('change', updateAmount);

      // React to theme-specific variant change events
      document.addEventListener('variant:change', function(e){
        if (e && e.detail && e.detail.variant) {
          var v = e.detail.variant;
          if (v && v.id && typeof v.price === 'number') priceById[v.id] = v.price;
          updateAmount();
        }
      });
      document.addEventListener('product:variant-change', function(){ updateAmount(); });

      // React to native changes on variant selector inputs
      document.addEventListener('change', function(ev){
        var t = ev.target;
        if (!t) return;
        if (t.name === 'id' || t.closest('variant-radios') || t.closest('variant-selects')) {
          updateAmount();
        }
      });

      // Initial calculation
      updateAmount();
    })();
    </script>

    <!-- Modales informativos -->
    <div id="modal-addi" class="financing-modal" style="display:none;">
      <div class="financing-modal__overlay"></div>
      <div class="financing-modal__content">
        <button class="financing-modal__close" aria-label="Cerrar">×</button>
        <div class="financing-modal__header">
          <img src="https://www.cyclewear.com.co/cdn/shop/t/67/assets/addi.svg" alt="Addi" style="max-height: 40px;">
        </div>
        <div class="financing-modal__body">
          <h3>Cómo hacer esta compra con Addi</h3>
          <ol class="financing-modal__steps">
            <li><strong>1.</strong> Escoge Addi al momento de pagar esta compra.</li>
            <li><strong>2.</strong> Sólo te pediremos tu cédula y WhatsApp para aplicar.</li>
            <li><strong>3.</strong> En unos pocos minutos te diremos si podemos aprobar un crédito para tu compra.</li>
            <li><strong>4.</strong> Te ofreceremos desde 6 hasta 24 cuotas, dependiendo del valor de tu compra y nuestros criterios de elegibilidad.</li>
          </ol>
          <button class="financing-modal__btn">Entendido</button>
          <div class="financing-modal__extra">
            <h4>También puedes pedir un crédito preaprobado</h4>
            <p>Si quieres hacer una compra de menor valor y es la primera vez que compras con nosotros, pide un crédito preaprobado.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-mercadopago" class="financing-modal" style="display:none;">
      <div class="financing-modal__overlay"></div>
      <div class="financing-modal__content">
        <button class="financing-modal__close" aria-label="Cerrar">×</button>
        <div class="financing-modal__header">
          <img src="https://cdn.shopify.com/s/files/1/0905/8631/7101/files/mercadopago-logo-blue.png" alt="Mercado Pago" style="max-height: 40px;">
        </div>
        <div class="financing-modal__body">
          <h3>Lleva tu compra a 3 cuotas con 0% de interés</h3>
          <p style="margin-bottom: 20px;">Pagando con tu tarjeta de crédito de los siguientes bancos aliados:</p>
          <div class="financing-modal__banks">
            <div class="bank-logo">Davivienda</div>
            <div class="bank-logo">Scotiabank</div>
            <div class="bank-logo">Colpatria</div>
            <div class="bank-logo">Banco de Bogotá</div>
            <div class="bank-logo">AV Villas</div>
            <div class="bank-logo">Banco Popular</div>
            <div class="bank-logo">Banco de Occidente</div>
            <div class="bank-logo">RappiCard</div>
            <div class="bank-logo">Tarjeta Éxito</div>
            <div class="bank-logo">Carulla</div>
            <div class="bank-logo">Nu</div>
            <div class="bank-logo">BBVA</div>
            <div class="bank-logo">Itaú</div>
            <div class="bank-logo">Codensa</div>
          </div>
          <p style="margin-top: 20px; font-size: 12px; color: #666;">Aplican términos y condiciones</p>
        </div>
      </div>
    </div>

    <script>
    (function(){
      // Modal functionality
      var modals = document.querySelectorAll('.financing-modal');
      var modalBtns = document.querySelectorAll('[data-modal]');
      
      modalBtns.forEach(function(btn){
        btn.addEventListener('click', function(){
          var modalId = this.getAttribute('data-modal');
          var modal = document.getElementById(modalId);
          if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
          }
        });
      });

      modals.forEach(function(modal){
        var overlay = modal.querySelector('.financing-modal__overlay');
        var closeBtn = modal.querySelector('.financing-modal__close');
        var actionBtn = modal.querySelector('.financing-modal__btn');

        function closeModal(){
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }

        if (overlay) overlay.addEventListener('click', closeModal);
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (actionBtn) actionBtn.addEventListener('click', closeModal);
      });

      // Cerrar con tecla ESC
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
          modals.forEach(function(modal){
            modal.style.display = 'none';
          });
          document.body.style.overflow = '';
        }
      });
    })();
    </script>
  </div>
{% endif %}
